<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wegmans Shopping List Builder</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ce3f24' stroke-width='2'%3E%3Cpath d='M3 6h18'/%3E%3Cpath d='M3 12h18'/%3E%3Cpath d='M3 18h18'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/auth.css">
</head>
<body>
    <!-- Mobile Action Bar (hidden on desktop) -->
    <div class="mobile-actions" style="display: none;">
        <button class="btn-export" onclick="exportToText()" id="mobileExportBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
            Copy
        </button>
        <button class="btn-print" onclick="printShoppingList()" id="mobilePrintBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"></polyline>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                <rect x="6" y="14" width="12" height="8"></rect>
            </svg>
            Print
        </button>
        <button class="btn-view-list" onclick="openModal('saveListModal')" id="mobileSaveBtn" style="background: var(--success-green);">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
            Save
        </button>
        <button class="past-lists-btn" onclick="showPastLists()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
            Lists
        </button>
        <button class="past-lists-btn" onclick="showRecipes()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3 9h9l-7.5 5.5L19 25l-7-5-7 5 2.5-8.5L0 11h9z"></path>
            </svg>
            Recipes
        </button>
        <button class="btn-clear" onclick="clearCart()" id="mobileClearBtn" style="background: var(--error-red); color: white;">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Clear
        </button>
    </div>

    <div class="header">
        <div class="header-inner">
            <div class="header-logo">
                <img src="https://www.wegmans.com/_next/static/media/logo.0b4fa879.svg" alt="Wegmans Logo">
            </div>
            <div class="header-content">
                <h1>Shopping List Builder</h1>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <div class="store-selector-wrapper">
                        <select id="stateSelector" onchange="updateStoreOptions()" class="store-selector">
                            <option value="">Select State</option>
                            <option value="NY">New York</option>
                            <option value="PA">Pennsylvania</option>
                            <option value="NJ">New Jersey</option>
                            <option value="VA">Virginia</option>
                            <option value="MD">Maryland</option>
                            <option value="NC">North Carolina</option>
                            <option value="MA">Massachusetts</option>
                        </select>
                        <select id="storeSelector" onchange="changeStore()" class="store-selector" disabled>
                            <option value="">Select Store</option>
                        </select>
                    </div>
                    <p class="subtitle" style="margin: 0;">Build your list one item at a time</p>
                </div>
            </div>
            <!-- Auth buttons (shown when not logged in) -->
            <div id="auth-buttons" style="margin-left: auto;">
                <button onclick="showLoginModal()" class="btn-primary">Log In</button>
                <button onclick="showRegisterModal()" class="btn-secondary">Sign Up</button>
            </div>
            <!-- User menu (shown when logged in) -->
            <div id="user-menu" style="display: none; margin-left: auto;">
                <span id="user-email"></span>
                <button onclick="auth.signOut()">Sign Out</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <div class="left-panel">
            <div class="search-section">
                <h2 class="section-heading">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Search for Products
                </h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="What are you looking for? (e.g., milk, eggs, bread)">
                    <button onclick="searchProducts()" id="searchBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        Search
                    </button>
                </div>
            </div>

            <div class="results-section" id="resultsSection" style="display: none;">
                <h3 class="subsection-heading">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    Select a Product
                </h3>
                <div class="results-grid" id="resultsGrid"></div>
                <button class="btn-load-more" id="loadMoreBtn" onclick="loadMoreResults()" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                    Load More Results
                </button>
            </div>

            <div class="empty-results" id="emptyResults">
                <div class="emoji">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="64" height="64">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </div>
                <p class="text-lg" style="font-weight: 600; color: var(--text-primary);">Ready to build your list?</p>
                <p class="mt-3 text-sm">Search for products like milk, eggs, bread, or anything else!</p>
            </div>

            <!-- Your Favorites (manually starred items) -->
            <div class="favorites-section" id="favoritesSection" style="display: none;">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" fill="currentColor"></polygon>
                    </svg>
                    Your Favorites
                </h2>
                <div class="favorite-items" id="favoriteItems"></div>
            </div>

            <!-- Frequently Bought Items (auto-learned from lists) -->
            <div class="frequent-section" id="frequentSection" style="display: none;">
                <h2>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                        <path d="M3 3v18h18"></path>
                        <path d="M18 17V9"></path>
                        <path d="M13 17V5"></path>
                        <path d="M8 17v-3"></path>
                    </svg>
                    Frequently Bought
                </h2>
                <div class="frequent-items" id="frequentItems"></div>
            </div>
        </div>

        <div class="right-panel">
            <div class="cart-section">
                <div class="cart-header" onclick="toggleCart()">
                    <span>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                            <path d="M3 6h18"></path>
                            <path d="M3 12h18"></path>
                            <path d="M3 18h18"></path>
                        </svg>
                        Your List
                    </span>
                    <span style="display: flex; align-items: center; gap: 8px;">
                        <span class="cart-count" id="cartCount">0</span>
                        <svg id="cartToggleIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="cart-toggle-icon">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </span>
                </div>

                <!-- Auto-save indicator -->
                <div id="autoSaveIndicator" class="auto-save-indicator" style="display: none;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    <span id="autoSaveText">Saved to: Today's List (0 items)</span>
                </div>

                <div class="cart-items" id="cartItems">
                    <div class="empty-cart">
                        <div class="emoji">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                                <path d="M3 6h18"></path>
                                <path d="M3 12h18"></path>
                                <path d="M3 18h18"></path>
                            </svg>
                        </div>
                        <p style="font-weight: 600; color: var(--text-primary); margin-bottom: var(--space-2);">Your list is empty</p>
                        <p class="text-xs">Start searching to add items!</p>
                    </div>
                </div>

                <div class="cart-totals" id="cartTotals" style="display: none;">
                    <div class="cart-total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="cart-total-row">
                        <span>Tax (est. 4%):</span>
                        <span id="tax">$0.00</span>
                    </div>
                    <div class="cart-total-row grand-total">
                        <span>Total:</span>
                        <span id="total">$0.00</span>
                    </div>
                </div>

                <div class="cart-actions">
                    <button class="btn-export" onclick="exportToText()" id="exportBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                        Copy as Text
                    </button>
                    <button class="btn-print" onclick="printShoppingList()" id="printListBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        Print Shopping List
                    </button>
                    <button class="btn-view-list" onclick="openModal('saveListModal')" id="saveCustomBtn" style="display: none; background: var(--success-green);">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        Save Custom List
                    </button>
                    <button class="past-lists-btn" onclick="showPastLists()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        Load Past Lists
                    </button>
                    <button class="past-lists-btn" onclick="showRecipes()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <path d="M12 2l3 9h9l-7.5 5.5L19 25l-7-5-7 5 2.5-8.5L0 11h9z"></path>
                        </svg>
                        My Recipes
                    </button>
                    <button class="btn-clear" onclick="clearCart()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                        Clear List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Saved Lists Modal -->
    <div class="saved-lists-modal" id="savedListsModal">
        <div class="saved-lists-content">
            <h2 style="margin-bottom: var(--space-6); color: var(--primary-red); font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                Your Past Shopping Lists
            </h2>
            <div id="savedListsContainer"></div>
            <div style="display: flex; flex-direction: column; gap: var(--space-3); margin-top: var(--space-6); max-width: 500px; margin-left: auto; margin-right: auto;">
                <button onclick="closeSavedLists()" style="width: 100%; padding: var(--space-4); background: var(--info-blue); color: white; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); cursor: pointer; transition: background 0.2s;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Recipes Modal -->
    <div class="saved-lists-modal" id="recipesModal">
        <div class="saved-lists-content">
            <h2 style="margin-bottom: var(--space-6); color: var(--primary-red); font-size: var(--font-size-2xl); font-weight: var(--font-weight-bold);">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M12 2l3 9h9l-7.5 5.5L19 25l-7-5-7 5 2.5-8.5L0 11h9z"></path>
                </svg>
                My Recipes
            </h2>
            <div id="recipesContainer"></div>
            <div style="display: flex; flex-direction: column; gap: var(--space-3); margin-top: var(--space-6); max-width: 500px; margin-left: auto; margin-right: auto;">
                <button onclick="openCreateRecipeEditor()" style="width: 100%; padding: var(--space-4); background: var(--success-green); color: white; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--space-2); transition: background 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Create New Recipe
                </button>
                <button onclick="showImportRecipeModal()" style="width: 100%; padding: var(--space-4); background: #3b82f6; color: white; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--space-2); transition: background 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Import Recipe
                </button>
                <button onclick="saveCartAsRecipe()" style="width: 100%; padding: var(--space-4); background: var(--gray-600); color: white; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--space-2); transition: background 0.2s;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Save List as Recipe
                </button>
                <button onclick="closeRecipes()" style="width: 100%; padding: var(--space-4); background: var(--info-blue); color: white; border: none; border-radius: var(--radius-md); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold); cursor: pointer; transition: background 0.2s;">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Save Recipe Modal -->
    <div class="quantity-modal" id="saveRecipeModal">
        <div class="quantity-modal-content">
            <h3>Save List as Recipe</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: var(--font-size-sm);">
                Give this recipe a name (e.g., "Cookie Recipe", "Taco Night")
            </p>
            <input type="text" id="recipeNameInput" placeholder="Recipe name..." style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-medium); border-radius: var(--radius-md); margin-bottom: var(--space-3); font-size: var(--font-size-base);">
            <input type="text" id="recipeDescriptionInput" placeholder="Description (optional)..." style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-medium); border-radius: var(--radius-md); margin-bottom: var(--space-4); font-size: var(--font-size-base);">
            <div class="quantity-modal-actions">
                <button onclick="confirmSaveRecipe()" class="btn-confirm">Save Recipe</button>
                <button onclick="closeModal('saveRecipeModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Import Recipe Modal -->
    <div class="quantity-modal" id="importRecipeModal">
        <div class="quantity-modal-content" style="max-width: 600px;">
            <h3>Import Recipe from Text</h3>

            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: var(--space-4);">
                Paste ingredients from any recipe website. We'll help you find Wegmans matches!
            </p>

            <div style="background: var(--gray-50); padding: var(--space-3); border-radius: var(--radius-md); margin-bottom: var(--space-4);">
                <strong style="display: block; margin-bottom: var(--space-2);">Example:</strong>
                <code style="font-size: 12px; display: block; white-space: pre-line;">2 tablespoons olive oil
1 medium onion, chopped
2 cloves garlic, minced</code>
            </div>

            <textarea
                id="importRecipeTextarea"
                placeholder="Paste your recipe ingredients here..."
                style="width: 100%; height: 300px; padding: var(--space-4); border: 2px solid var(--border-light); border-radius: var(--radius-md); font-size: 14px; font-family: inherit; resize: vertical;"
            ></textarea>

            <div class="quantity-modal-actions" style="margin-top: var(--space-4);">
                <button class="btn-cancel" onclick="closeModal('importRecipeModal')">Cancel</button>
                <button class="btn-confirm" onclick="startRecipeImport()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Parse & Import
                </button>
            </div>
        </div>
    </div>

    <!-- Recipe Editor Modal (Import/Create/Edit) -->
    <div class="quantity-modal" id="recipeEditorModal">
        <div class="quantity-modal-content" style="max-width: 800px; max-height: 90vh;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                <h3 style="margin: 0;" id="recipeEditorTitle">Recipe Editor</h3>
                <button onclick="closeModal('recipeEditorModal')" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary);">Ã—</button>
            </div>

            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: var(--space-4);" id="recipeEditorSubtitle">
                Review the matches we found. Click a product to select it, or use Search/Skip for each ingredient.
            </p>

            <!-- Add Ingredient Button (for create/edit modes) -->
            <div id="editorAddIngredientBar" style="display: none; margin-bottom: var(--space-4);">
                <button onclick="addIngredientToEditor()" style="width: 100%; padding: var(--space-3); background: #3b82f6; color: white; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: var(--space-2);">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    Add Ingredient
                </button>
            </div>

            <!-- Scrollable ingredient list -->
            <div id="recipeEditorList" style="max-height: 60vh; overflow-y: auto; margin-bottom: var(--space-6);"></div>

            <!-- Bottom action bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding-top: var(--space-4); border-top: 2px solid var(--border-light);">
                <div style="font-size: 14px; color: var(--text-secondary);">
                    <span id="editorSelectedCount">0</span> items selected
                </div>
                <div style="display: flex; gap: var(--space-3);" id="editorActionButtons">
                    <button class="btn-cancel" onclick="closeModal('recipeEditorModal')">Cancel</button>
                    <button class="btn-confirm" onclick="saveRecipeFromEditor()" id="editorSaveBtn" style="background: #3b82f6;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <path d="M12 2l3 9h9l-7.5 5.5L19 25l-7-5-7 5 2.5-8.5L0 11h9z"></path>
                        </svg>
                        <span id="editorSaveBtnText">Save as Recipe</span>
                    </button>
                    <button class="btn-confirm" onclick="addRecipeToList()" id="editorAddToListBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        Add <span id="editorAddToListCount">0</span> Items to List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredient Search Modal (for adding/substituting ingredients) -->
    <div class="quantity-modal" id="ingredientSearchModal">
        <div class="quantity-modal-content" style="max-width: 600px;">
            <h3 id="ingredientSearchTitle">Find Ingredient</h3>

            <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: var(--space-4);">
                <span id="ingredientSearchContext">Search for an ingredient:</span> <strong id="itemSearchIngredient"></strong>
            </p>

            <div style="display: flex; gap: var(--space-2); margin-bottom: var(--space-4);">
                <input
                    type="text"
                    id="itemSearchInput"
                    placeholder="Search for ingredient..."
                    style="flex: 1; padding: var(--space-3); border: 2px solid var(--border-light); border-radius: var(--radius-md); font-size: 14px;"
                    onkeypress="if(event.key==='Enter') searchForIngredient()"
                >
                <button onclick="searchForIngredient()" style="padding: var(--space-3) var(--space-4); background: #3b82f6; color: white; border: none; border-radius: var(--radius-md); font-weight: 600; cursor: pointer;">
                    Search
                </button>
            </div>

            <!-- Search results -->
            <div id="itemSearchResults" style="max-height: 400px; overflow-y: auto; margin-bottom: var(--space-4);"></div>

            <!-- Bottom actions -->
            <div style="display: flex; justify-content: space-between; gap: var(--space-3);">
                <button class="btn-cancel" onclick="closeIngredientSearchModal()">Back</button>
                <button class="btn-secondary" onclick="skipCurrentIngredient()" id="skipIngredientBtn" style="background: var(--gray-600); color: white; padding: var(--space-3) var(--space-4); border: none; border-radius: var(--radius-md); cursor: pointer;">Skip This Item</button>
            </div>
        </div>
    </div>

    <!-- Interactive Add Modal -->
    <div class="quantity-modal" id="interactiveAddModal">
        <div class="quantity-modal-content">
            <h3>Do you need this item?</h3>
            <div class="quantity-modal-product" style="margin-bottom: var(--space-4);">
                <div class="quantity-modal-product-name" id="interactiveItemName" style="font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);"></div>
                <div class="quantity-modal-product-price" id="interactiveItemPrice" style="color: var(--text-secondary);"></div>
                <div id="interactiveItemQuantity" style="color: var(--text-secondary); font-size: var(--font-size-sm); margin-top: var(--space-2);"></div>
            </div>
            <div style="text-align: center; color: var(--text-secondary); font-size: var(--font-size-sm); margin-bottom: var(--space-4);" id="interactiveProgress">
                Item 1 of 5
            </div>
            <div class="quantity-modal-actions">
                <button onclick="addRecipeItemToCart()" class="btn-confirm">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add to List
                </button>
                <button onclick="skipRecipeItem()" class="btn-cancel">Skip</button>
            </div>
        </div>
    </div>

    <!-- Delete Recipe Confirmation Modal -->
    <div class="quantity-modal" id="deleteRecipeModal">
        <div class="quantity-modal-content">
            <h3>Delete This Recipe?</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: var(--font-size-base);" id="deleteRecipeMessage">
                Are you sure you want to delete this recipe?
            </p>
            <div class="quantity-modal-actions">
                <button onclick="confirmDeleteRecipe()" class="btn-confirm" style="background: var(--error-red);">Delete Recipe</button>
                <button onclick="closeModal('deleteRecipeModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Searching Wegmans...</div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Save Custom List Modal -->
    <div class="quantity-modal" id="saveListModal">
        <div class="quantity-modal-content">
            <h3>Save Custom List</h3>
            <input type="text" id="customListName" placeholder="Enter list name (e.g., Thanksgiving)..." style="width: 100%; padding: var(--space-3); border: 1px solid var(--border-medium); border-radius: var(--radius-md); margin-bottom: var(--space-4); font-size: var(--font-size-base);">
            <div class="quantity-modal-actions">
                <button onclick="saveCustomListNow()" class="btn-confirm">Save List</button>
                <button onclick="closeModal('saveListModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Clear List Button Confirmation Modal -->
    <div class="quantity-modal" id="clearCartButtonModal">
        <div class="quantity-modal-content">
            <h3>Clear Entire List?</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: var(--font-size-base);">
                This will remove all items from your list.
            </p>
            <div class="quantity-modal-actions">
                <button onclick="confirmClearCart()" class="btn-confirm">Yes, Clear List</button>
                <button onclick="closeModal('clearCartButtonModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Remove Favorite Confirmation Modal -->
    <div class="quantity-modal" id="removeFavoriteModal">
        <div class="quantity-modal-content">
            <h3>Remove from Favorites?</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: var(--font-size-base);" id="removeFavoriteMessage">
                Are you sure you want to remove this item from your favorites?
            </p>
            <div class="quantity-modal-actions">
                <button onclick="confirmRemoveFavorite()" class="btn-confirm-delete">Remove Favorite</button>
                <button onclick="closeModal('removeFavoriteModal')" class="btn-cancel-delete">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete List Confirmation Modal -->
    <div class="quantity-modal" id="deleteListModal">
        <div class="quantity-modal-content">
            <h3>Delete This List?</h3>
            <p style="color: var(--text-secondary); margin-bottom: var(--space-4); font-size: var(--font-size-base);" id="deleteListMessage">
                Are you sure you want to delete this list?
            </p>
            <div class="quantity-modal-actions">
                <button onclick="confirmDeleteList()" class="btn-confirm" style="background: var(--error-red);">Delete List</button>
                <button onclick="closeModal('deleteListModal')" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Quantity Selector Modal -->
    <div class="quantity-modal" id="quantityModal">
        <div class="quantity-modal-content">
            <h3>How many would you like?</h3>

            <div class="quantity-modal-product">
                <div class="quantity-modal-product-name" id="qtyProductName"></div>
                <div class="quantity-modal-product-price" id="qtyProductPrice"></div>
            </div>

            <!-- Weight item hint (hidden by default, shown for weight items) -->
            <div class="weight-hint" id="weightItemHint" style="display: none;">
                <div class="hint-icon">ðŸ’¡</div>
                <div class="hint-text">
                    This item is sold by <strong><span id="weightUnitName">weight</span></strong>.
                    You can enter decimal amounts (e.g., <span id="weightExample">1.5</span>).
                </div>
            </div>

            <div class="quantity-selector">
                <label class="quantity-selector-label" id="quantitySelectorLabel">Select Quantity (1-10)</label>
                <div class="quantity-slider-container">
                    <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">1</span>
                    <input type="range" min="1" max="10" value="1" class="quantity-slider" id="quantitySlider">
                    <span style="color: var(--text-secondary); font-size: var(--font-size-sm);">10</span>
                </div>
                <div class="quantity-display" id="quantityDisplay">1</div>
            </div>

            <div class="quantity-custom">
                <label class="quantity-custom-label">Need more? Enter custom amount:</label>
                <input type="number" min="1" placeholder="e.g., 20" class="quantity-custom-input" id="customQuantityInput">
            </div>

            <div class="quantity-modal-actions">
                <button class="btn-cancel-quantity" onclick="closeQuantityModal()">Cancel</button>
                <button class="btn-add-quantity" onclick="confirmAddQuantity()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    Add to List
                </button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-modal" id="deleteModal">
        <div class="delete-modal-content">
            <div class="delete-modal-icon">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </div>
            <h3>Remove item?</h3>
            <div class="delete-modal-message" id="deleteMessage"></div>
            <div class="delete-modal-actions">
                <button class="btn-cancel-delete" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-confirm-delete" onclick="confirmDelete()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                    Yes, Remove
                </button>
            </div>
        </div>
    </div>

    <!-- Recipe Overwrite Confirmation Modal -->
    <div class="delete-modal" id="recipeOverwriteModal">
        <div class="delete-modal-content">
            <div class="delete-modal-icon" style="background: linear-gradient(135deg, #ff9a56 0%, #ff6a88 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>
            <h3>Duplicate recipe name</h3>
            <div class="delete-modal-message">
                A recipe named "<strong id="overwriteRecipeName"></strong>" already exists.
                Do you want to replace it with your current cart?
            </div>
            <div class="delete-modal-actions">
                <button class="btn-cancel-delete" onclick="closeRecipeOverwriteModal()">Cancel</button>
                <button class="btn-confirm-delete" onclick="confirmOverwriteRecipe()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                        <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Yes, Replace
                </button>
            </div>
        </div>
    </div>

    <!-- Final List Modal -->
    <div class="final-list-modal" id="finalListModal">
        <div class="final-list-content">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 8px;">
                    <path d="M3 6h18"></path>
                    <path d="M3 12h18"></path>
                    <path d="M3 18h18"></path>
                </svg>
                Your Shopping List - Organized by Aisle
            </h2>
            <div id="finalListTable"></div>

            <div class="save-list-section">
                <h3 style="margin-bottom: var(--space-3); font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold);">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save This List
                </h3>
                <input type="text" id="saveListName" placeholder="List name (e.g., 'Weekly Groceries', 'Party Supplies')">
                <button onclick="saveCurrentList()" class="btn-view-list">
                    Save to Browser
                </button>
            </div>

            <div class="modal-actions">
                <button onclick="closeFinalList()" class="btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    Back to Shopping
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modals -->

    <!-- Login Modal -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('login-modal')">&times;</span>
            <h2>Log In</h2>
            <form onsubmit="handleLogin(event)">
                <input type="email" id="login-email" placeholder="Email" required autocomplete="email">
                <input type="password" id="login-password" placeholder="Password" required autocomplete="current-password">
                <button type="submit" class="btn-primary">Log In</button>
            </form>
            <p>
                <a href="#" onclick="showForgotPasswordModal(); return false;">Forgot password?</a>
            </p>
            <p>
                Don't have an account?
                <a href="#" onclick="showRegisterModal(); return false;">Sign up</a>
            </p>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('register-modal')">&times;</span>
            <h2>Sign Up</h2>
            <form onsubmit="handleRegister(event)">
                <input type="email" id="register-email" placeholder="Email" required autocomplete="email">
                <input type="password" id="register-password" placeholder="Password (min 6 chars)" required minlength="6" autocomplete="new-password">
                <input type="password" id="register-confirm" placeholder="Confirm Password" required minlength="6" autocomplete="new-password">
                <button type="submit" class="btn-primary">Sign Up</button>
            </form>
            <p>
                Already have an account?
                <a href="#" onclick="showLoginModal(); return false;">Log in</a>
            </p>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('forgot-password-modal')">&times;</span>
            <h2>Reset Password</h2>
            <form onsubmit="handleForgotPassword(event)">
                <input type="email" id="forgot-email" placeholder="Email" required autocomplete="email">
                <button type="submit" class="btn-primary">Send Reset Link</button>
            </form>
            <p>
                <a href="#" onclick="showLoginModal(); return false;">Back to login</a>
            </p>
        </div>
    </div>

    <!-- Store Switch Warning Modal -->
    <div class="quantity-modal" id="switchStoreModal">
        <div class="quantity-modal-content">
            <h3>Switch Stores?</h3>
            <div id="switchStoreMessage" style="margin-bottom: var(--space-4); color: var(--text-secondary); line-height: 1.5;">
                <!-- Content injected by JavaScript -->
            </div>
            <div class="quantity-modal-actions">
                <button onclick="confirmStoreSwitch()" class="btn-confirm">Yes, Switch</button>
                <button onclick="cancelStoreSwitch()" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/modals.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
